/*
 * Bearsampp Development Kit - Gradle Build
 *
 * This is a hybrid build configuration that:
 * 1. Imports existing Ant build files for backward compatibility
 * 2. Provides modern Gradle features (caching, incremental builds, parallel execution)
 * 3. Allows gradual migration from Ant to Gradle
 *
 * Usage:
 *   gradle tasks          - List all available tasks
 *   gradle release        - Run the Ant release task
 *   gradle loadLib        - Load all required libraries
 *   gradle hashAll        - Generate hashes for all artifacts
 */

plugins {
    id 'base'
}

// Project information
group = 'com.bearsampp'
version = '1.0.0'
description = 'Bearsampp Development Kit'

// Define project paths
ext {
    devPath = projectDir.absolutePath
    buildPath = file("${projectDir.parent}/bearsampp-build").absolutePath
    binPath = file("${projectDir}/bin").absolutePath
    libPath = file("${projectDir}/bin/lib").absolutePath
    toolsPath = file("${projectDir}/tools").absolutePath
    phpdevPath = file("${projectDir}/phpdev").absolutePath
}

// Configure repositories for dependencies
repositories {
    mavenCentral()
}

// ============================================================================
// ANT INTEGRATION - Import existing Ant build files
// ============================================================================

// Set Ant properties before importing
ant.properties['project.basedir'] = projectDir.absolutePath.toString()
ant.properties['dev.path'] = ext.devPath.toString()
ant.properties['root.dir'] = projectDir.parent.toString()

// Import Ant build files
// This allows you to run all existing Ant targets as Gradle tasks
ant.importBuild('build/build-commons.xml') { antTargetName ->
    // Prefix Ant tasks to avoid conflicts with Gradle tasks
    return "ant-${antTargetName}".toString()
}

// Note: build-bundle.xml and build-release.xml require additional properties
// They can be imported when needed for specific module builds

// ============================================================================
// GRADLE NATIVE TASKS - Modern alternatives to Ant tasks
// ============================================================================

// Task: Initialize build directories
tasks.register('initDirs') {
    group = 'build setup'
    description = 'Initialize build directories'

    doLast {
        mkdir(ext.binPath)
        mkdir(ext.libPath)
        mkdir(ext.buildPath)
        println "✓ Build directories initialized"
    }
}

// Task: Clean build artifacts (extends base plugin's clean task)
tasks.named('clean') {
    doLast {
        delete file("${ext.buildPath}/tmp")
        println "✓ Build artifacts cleaned"
    }
}

// Task: Display build information
tasks.register('info') {
    group = 'help'
    description = 'Display build configuration information'

    doLast {
        println """
        ╔════════════════════════════════════════════════════════════════╗
        ║           Bearsampp Development Kit - Build Info               ║
        ╚═══════════════════════════════════════════════��════════════════╝

        Project:        ${project.name}
        Version:        ${project.version}
        Description:    ${project.description}

        Paths:
          Dev Path:     ${project.ext.devPath}
          Build Path:   ${project.ext.buildPath}
          Bin Path:     ${project.ext.binPath}
          Lib Path:     ${project.ext.libPath}
          Tools Path:   ${project.ext.toolsPath}
          PHPDev Path:  ${project.ext.phpdevPath}

        Java:
          Version:      ${JavaVersion.current()}
          Home:         ${System.getProperty('java.home')}

        Gradle:
          Version:      ${gradle.gradleVersion}
          Home:         ${gradle.gradleHomeDir}

        Available Task Groups:
          • build setup  - Initialize and configure build environment
          • build        - Build and package tasks
          • ant tasks    - Legacy Ant tasks (prefixed with 'ant-')
          • help         - Help and information tasks

        Quick Start:
          gradle tasks --all     - List all available tasks
          gradle info            - Show this information
          gradle loadLibs        - Download required libraries
          gradle verify          - Verify build environment
        """.stripIndent()
    }
}

// Task: Download and setup required libraries (Gradle native version)
tasks.register('loadLibs') {
    group = 'build setup'
    description = 'Download required libraries (Gradle native implementation)'

    dependsOn 'initDirs'

    doLast {
        println "Downloading required libraries..."

        def libs = [
            'ant-contrib': 'https://repo1.maven.org/maven2/ant-contrib/ant-contrib/1.0b3/ant-contrib-1.0b3.jar',
            'composer': 'https://github.com/composer/composer/releases/download/2.8.5/composer.phar',
            'innoextract': 'https://github.com/dscharrer/innoextract/releases/download/1.9/innoextract-1.9-windows.zip',
            'hashmyfiles': 'https://www.nirsoft.net/utils/hashmyfiles-x64.zip',
            'lessmsi': 'https://github.com/activescott/lessmsi/releases/download/v2.5.1/lessmsi-v2.5.1.zip'
        ]

        libs.each { name, url ->
            def fileName = url.substring(url.lastIndexOf('/') + 1)
            def destFile = file("${ext.libPath}/${fileName}")

            if (!destFile.exists()) {
                println "  Downloading ${name}..."
                ant.get(src: url, dest: destFile, skipexisting: true)

                // Extract archives
                if (fileName.endsWith('.zip')) {
                    def extractDir = file("${ext.libPath}/${name}")
                    if (!extractDir.exists()) {
                        println "  Extracting ${fileName}..."
                        ant.unzip(src: destFile, dest: extractDir)
                    }
                }
            } else {
                println "  ✓ ${name} already exists"
            }
        }

        println "✓ All libraries downloaded"
    }
}

// Task: Verify build environment
tasks.register('verify') {
    group = 'build setup'
    description = 'Verify build environment and dependencies'

    doLast {
        println "Verifying build environment..."

        def checks = [:]

        // Check Java version
        def javaVersion = JavaVersion.current()
        checks['Java 11+'] = javaVersion >= JavaVersion.VERSION_11

        // Check required directories
        checks['Dev directory'] = projectDir.exists()
        checks['Build directory'] = file(ext.buildPath).exists() || true // Will be created
        checks['Tools directory'] = file(ext.toolsPath).exists()
        checks['PHPDev directory'] = file(ext.phpdevPath).exists()

        // Check PHP
        def phpExe = file("${ext.toolsPath}/php/php.exe")
        checks['PHP executable'] = phpExe.exists()

        // Check 7zip
        def sevenZip = file("${ext.toolsPath}/7zip/7za.exe")
        checks['7-Zip'] = sevenZip.exists()

        println "\nEnvironment Check Results:"
        println "─".multiply(50)
        checks.each { name, passed ->
            def status = passed ? "✓ PASS" : "✗ FAIL"
            println "  ${status.padRight(10)} ${name}"
        }
        println "─".multiply(50)

        def allPassed = checks.values().every { it }
        if (allPassed) {
            println "\n✓ All checks passed! Build environment is ready."
        } else {
            println "\n⚠ Some checks failed. Please review the requirements."
        }
    }
}

// Task: Wrapper for Ant release task (convenience)
// Note: This task requires module-specific configuration
// Use Ant directly for now: ant release
tasks.register('release') {
    group = 'build'
    description = 'Create release package (requires module-specific setup)'

    doLast {
        println """
        Release task requires module-specific configuration.

        For now, use Ant directly in your module directory:
          ant release

        This will be improved in future Gradle versions.
        """.stripIndent()
    }
}

// Task: Wrapper for loading Ant libraries
tasks.register('loadAntLibs') {
    group = 'build setup'
    description = 'Load libraries using Ant (legacy method)'

    dependsOn 'ant-load.lib'

    doLast {
        println "✓ Ant libraries loaded"
    }
}

// Task: Generate hashes for all artifacts
tasks.register('hashAll') {
    group = 'build'
    description = 'Generate hash files for all build artifacts'

    dependsOn 'ant-hash.all'

    doLast {
        println "✓ Hash files generated"
    }
}

// ============================================================================
// CUSTOM TASK RULES
// ============================================================================

// Allow running Ant tasks without the 'ant-' prefix by using 'antTask' pattern
tasks.addRule("Pattern: antTask<TaskName> - Run Ant task directly") { String taskName ->
    if (taskName.startsWith("antTask")) {
        task(taskName) {
            dependsOn "ant-${taskName - 'antTask'}"
        }
    }
}

// ============================================================================
// BUILD LIFECYCLE HOOKS
// ============================================================================

gradle.taskGraph.whenReady { graph ->
    println """
    ╔════════════════════════════════════════════════════════════════╗
    ║  Bearsampp Build - Gradle + Ant Hybrid                         ║
    ╚════════════════════════════════════════════════════════════════╝
    """.stripIndent()
}

// ============================================================================
// HELPER METHODS
// ============================================================================

// Method to check if a command exists in PATH
def commandExists(String command) {
    try {
        def process = Runtime.runtime.exec(command)
        process.waitFor()
        return true
    } catch (IOException e) {
        return false
    }
}
